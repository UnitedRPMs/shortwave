From 164b18de79ebc765818ccd9b718f1527c92ba19e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Felix=20H=C3=A4cker?= <haeckerfelix@gnome.org>
Date: Wed, 10 Jun 2020 17:17:04 +0200
Subject: [PATCH] port to libhandy-1

---
 Cargo.lock                                     | 17 +++++++++--------
 Cargo.toml                                     |  2 +-
 build-aux/de.haeckerfelix.Shortwave.Beta.json  |  3 +--
 build-aux/de.haeckerfelix.Shortwave.Devel.json |  3 +--
 build-aux/de.haeckerfelix.Shortwave.json       |  3 +--
 data/gtk/featured_carousel.ui                  |  2 +-
 data/gtk/station_dialog.ui                     |  2 +-
 data/gtk/streaming_dialog.ui                   |  2 +-
 data/gtk/window.ui                             |  2 --
 meson.build                                    |  2 +-
 src/ui/featured_carousel.rs                    |  6 +++---
 src/ui/station_dialog.rs                       |  5 ++---
 src/ui/streaming_dialog.rs                     |  6 +++---
 src/ui/window.rs                               |  6 +++---
 14 files changed, 28 insertions(+), 33 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index 562ee21c..3cd855f9 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -916,8 +916,8 @@ dependencies = [
 
 [[package]]
 name = "libhandy"
-version = "0.5.0"
-source = "git+https://gitlab.gnome.org/haecker-felix/libhandy-rs.git?branch=update_cargo_version#62e7abf44d419cf3fe83da64285f2905da4e333e"
+version = "1.0.0"
+source = "git+https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs#ee81f1d3924f1d73ea19ba9f4c111d6e6ec705f7"
 dependencies = [
  "bitflags 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "gdk 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -931,16 +931,17 @@ dependencies = [
  "gtk-sys 0.9.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "libc 0.2.66 (registry+https://github.com/rust-lang/crates.io-index)",
- "libhandy-sys 0.5.0 (git+https://gitlab.gnome.org/haecker-felix/libhandy-rs.git?branch=update_cargo_version)",
+ "libhandy-sys 1.0.0 (git+https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs)",
  "pango 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "libhandy-sys"
-version = "0.5.0"
-source = "git+https://gitlab.gnome.org/haecker-felix/libhandy-rs.git?branch=update_cargo_version#62e7abf44d419cf3fe83da64285f2905da4e333e"
+version = "1.0.0"
+source = "git+https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs#ee81f1d3924f1d73ea19ba9f4c111d6e6ec705f7"
 dependencies = [
  "gdk 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "gdk-pixbuf-sys 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "gdk-sys 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "gio 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "gio-sys 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -1578,7 +1579,7 @@ dependencies = [
  "indexmap 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "isahc 0.9.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "libhandy 0.5.0 (git+https://gitlab.gnome.org/haecker-felix/libhandy-rs.git?branch=update_cargo_version)",
+ "libhandy 1.0.0 (git+https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs)",
  "log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)",
  "matches 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)",
  "mdns 0.3.2 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -1894,8 +1895,8 @@ dependencies = [
 "checksum lazy_static 1.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "e2abad23fbc42b3700f2f279844dc832adb2b2eb069b2df918f455c4e18cc646"
 "checksum libc 0.2.66 (registry+https://github.com/rust-lang/crates.io-index)" = "d515b1f41455adea1313a4a2ac8a8a477634fbae63cc6100e3aebb207ce61558"
 "checksum libdbus-sys 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "dc12a3bc971424edbbf7edaf6e5740483444db63aa8e23d3751ff12a30f306f0"
-"checksum libhandy 0.5.0 (git+https://gitlab.gnome.org/haecker-felix/libhandy-rs.git?branch=update_cargo_version)" = "<none>"
-"checksum libhandy-sys 0.5.0 (git+https://gitlab.gnome.org/haecker-felix/libhandy-rs.git?branch=update_cargo_version)" = "<none>"
+"checksum libhandy 1.0.0 (git+https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs)" = "<none>"
+"checksum libhandy-sys 1.0.0 (git+https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs)" = "<none>"
 "checksum libnghttp2-sys 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "b359f5ec8106bc297694c9a562ace312be2cfd17a5fc68dc12249845aa144b11"
 "checksum libsqlite3-sys 0.16.0 (registry+https://github.com/rust-lang/crates.io-index)" = "5e5b95e89c330291768dc840238db7f9e204fd208511ab6319b56193a7f2ae25"
 "checksum libz-sys 1.0.25 (registry+https://github.com/rust-lang/crates.io-index)" = "2eb5e43362e38e2bca2fd5f5134c4d4564a23a5c28e9b95411652021a8675ebe"
diff --git a/Cargo.toml b/Cargo.toml
index d55d84ad..9b6e3b3e 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -42,7 +42,7 @@ gtk = { version = "0.8.0", features = ["v3_22"] }
 gio = { version = "0.8.0", features = ["v2_46"] }
 gdk-pixbuf = { version = "0.8.0", features = ["v2_36"] }
 gettext-rs = { version = "0.4.4", features = ["gettext-system"] }
-libhandy = { git="https://gitlab.gnome.org/haecker-felix/libhandy-rs.git", branch = "update_cargo_version", features = ["v0_0_12"] }
+libhandy = { git="https://gitlab.gnome.org/bilelmoussaoui/libhandy-rs", features = ["v1_0"] }
 gtk-macros = "0.2.0"
 
 [target.'cfg(unix)'.dependencies]
diff --git a/build-aux/de.haeckerfelix.Shortwave.Beta.json b/build-aux/de.haeckerfelix.Shortwave.Beta.json
index 9d92b507..ffaa665a 100644
--- a/build-aux/de.haeckerfelix.Shortwave.Beta.json
+++ b/build-aux/de.haeckerfelix.Shortwave.Beta.json
@@ -12,7 +12,6 @@
     ],
     "finish-args" : [
         "--filesystem=xdg-music",
-        "--filesystem=home",
         "--share=network",
         "--share=ipc",
         "--socket=x11",
@@ -52,7 +51,7 @@
                 {
                     "type" : "git",
                     "url" : "https://source.puri.sm/Librem5/libhandy.git",
-                    "branch": "libhandy-0-0"
+                    "tag": "v0.80.0"
                 }
             ]
         },
diff --git a/build-aux/de.haeckerfelix.Shortwave.Devel.json b/build-aux/de.haeckerfelix.Shortwave.Devel.json
index a2fe2512..cb0af6da 100644
--- a/build-aux/de.haeckerfelix.Shortwave.Devel.json
+++ b/build-aux/de.haeckerfelix.Shortwave.Devel.json
@@ -12,7 +12,6 @@
     ],
     "finish-args" : [
         "--filesystem=xdg-music",
-        "--filesystem=home",
         "--share=network",
         "--share=ipc",
         "--socket=x11",
@@ -56,7 +55,7 @@
                 {
                     "type" : "git",
                     "url" : "https://source.puri.sm/Librem5/libhandy.git",
-                    "branch": "libhandy-0-0"
+                    "tag": "v0.80.0"
                 }
             ]
         },
diff --git a/build-aux/de.haeckerfelix.Shortwave.json b/build-aux/de.haeckerfelix.Shortwave.json
index ff927d70..b9db1c27 100644
--- a/build-aux/de.haeckerfelix.Shortwave.json
+++ b/build-aux/de.haeckerfelix.Shortwave.json
@@ -9,7 +9,6 @@
     "command" : "shortwave",
     "finish-args" : [
         "--filesystem=xdg-music",
-        "--filesystem=home",
         "--share=network",
         "--share=ipc",
         "--socket=x11",
@@ -46,7 +45,7 @@
                 {
                     "type" : "git",
                     "url" : "https://source.puri.sm/Librem5/libhandy.git",
-                    "tag": "v0.0.13"
+                    "tag": "v0.80.0"
                 }
             ]
         },
diff --git a/data/gtk/featured_carousel.ui b/data/gtk/featured_carousel.ui
index 1280c3c2..c78e669c 100644
--- a/data/gtk/featured_carousel.ui
+++ b/data/gtk/featured_carousel.ui
@@ -12,7 +12,7 @@
         <property name="visible">True</property>
         <property name="can_focus">False</property>
         <child>
-          <object class="HdyPaginator" id="paginator">
+          <object class="HdyCarousel" id="paginator">
             <property name="height_request">150</property>
             <property name="visible">True</property>
             <property name="can_focus">False</property>
diff --git a/data/gtk/station_dialog.ui b/data/gtk/station_dialog.ui
index 66c1dbe3..b4071497 100644
--- a/data/gtk/station_dialog.ui
+++ b/data/gtk/station_dialog.ui
@@ -3,7 +3,7 @@
 <interface>
   <requires lib="gtk+" version="3.22"/>
   <requires lib="libhandy" version="0.0"/>
-  <object class="HdyDialog" id="station_dialog">
+  <object class="GtkDialog" id="station_dialog">
     <property name="width_request">325</property>
     <property name="height_request">575</property>
     <property name="can_focus">False</property>
diff --git a/data/gtk/streaming_dialog.ui b/data/gtk/streaming_dialog.ui
index 1cce75f9..c84794c4 100644
--- a/data/gtk/streaming_dialog.ui
+++ b/data/gtk/streaming_dialog.ui
@@ -59,7 +59,7 @@
       </object>
     </child>
   </object>
-  <object class="HdyDialog" id="streaming_dialog">
+  <object class="GtkDialog" id="streaming_dialog">
     <property name="width_request">350</property>
     <property name="height_request">400</property>
     <property name="can_focus">False</property>
diff --git a/data/gtk/window.ui b/data/gtk/window.ui
index 54dfa544..2cb7026a 100644
--- a/data/gtk/window.ui
+++ b/data/gtk/window.ui
@@ -17,8 +17,6 @@
           <object class="HdyLeaflet" id="leaflet">
             <property name="visible">True</property>
             <property name="can_focus">False</property>
-            <property name="mode_transition_type">slide</property>
-            <property name="child_transition_type">over</property>
             <child>
               <object class="GtkStack" id="view_stack">
                 <property name="visible">True</property>
diff --git a/meson.build b/meson.build
index 1c418d21..1ab628f4 100644
--- a/meson.build
+++ b/meson.build
@@ -13,7 +13,7 @@ dependency('glib-2.0', version: '>= 2.56')
 dependency('gio-2.0', version: '>= 2.56')
 dependency('gdk-pixbuf-2.0')
 dependency('gtk+-3.0', version: '>= 3.24.11')
-dependency('libhandy-0.0', version: '>= 0.0.12')
+dependency('libhandy-1', version: '>= 0.80.0')
 
 dependency('gstreamer-1.0', version: '>= 1.16')
 dependency('gstreamer-base-1.0', version: '>= 1.16')
diff --git a/src/ui/featured_carousel.rs b/src/ui/featured_carousel.rs
index 16a09295..9cc6709d 100644
--- a/src/ui/featured_carousel.rs
+++ b/src/ui/featured_carousel.rs
@@ -16,7 +16,7 @@
 
 use gtk::prelude::*;
 use libhandy::prelude::*;
-use libhandy::Paginator;
+use libhandy::Carousel;
 
 use std::cell::RefCell;
 use std::convert::TryInto;
@@ -24,7 +24,7 @@ use std::rc::Rc;
 
 pub struct FeaturedCarousel {
     pub widget: gtk::Box,
-    paginator: Paginator,
+    paginator: Carousel,
 
     pages: Rc<RefCell<Vec<gtk::Box>>>,
     visible_page: Rc<RefCell<usize>>,
@@ -36,7 +36,7 @@ impl FeaturedCarousel {
     pub fn new() -> Self {
         let builder = gtk::Builder::new_from_resource("/de/haeckerfelix/Shortwave/gtk/featured_carousel.ui");
         get_widget!(builder, gtk::Box, featured_carousel);
-        get_widget!(builder, Paginator, paginator);
+        get_widget!(builder, Carousel, paginator);
 
         let pages = Rc::new(RefCell::new(Vec::new()));
         let visible_page = Rc::new(RefCell::new(0));
diff --git a/src/ui/station_dialog.rs b/src/ui/station_dialog.rs
index 360f8b80..d09080ae 100644
--- a/src/ui/station_dialog.rs
+++ b/src/ui/station_dialog.rs
@@ -17,7 +17,6 @@
 use futures_util::future::FutureExt;
 use glib::Sender;
 use gtk::prelude::*;
-use libhandy::Dialog;
 
 use crate::api::{FaviconDownloader, Station};
 use crate::app::Action;
@@ -26,7 +25,7 @@ use crate::ui::{FaviconSize, StationFavicon};
 use crate::utils;
 
 pub struct StationDialog {
-    pub widget: Dialog,
+    pub widget: gtk::Dialog,
     station: Station,
 
     title_label: gtk::Label,
@@ -48,7 +47,7 @@ pub struct StationDialog {
 impl StationDialog {
     pub fn new(sender: Sender<Action>, station: Station) -> Self {
         let builder = gtk::Builder::new_from_resource("/de/haeckerfelix/Shortwave/gtk/station_dialog.ui");
-        get_widget!(builder, Dialog, station_dialog);
+        get_widget!(builder, gtk::Dialog, station_dialog);
         get_widget!(builder, gtk::Label, title_label);
         get_widget!(builder, gtk::Label, subtitle_label);
         get_widget!(builder, gtk::Label, codec_label);
diff --git a/src/ui/streaming_dialog.rs b/src/ui/streaming_dialog.rs
index 8260c81b..68e2699a 100644
--- a/src/ui/streaming_dialog.rs
+++ b/src/ui/streaming_dialog.rs
@@ -27,7 +27,7 @@ use crate::audio::GCastDiscovererMessage;
 use crate::utils;
 
 pub struct StreamingDialog {
-    pub widget: libhandy::Dialog,
+    pub widget: gtk::Dialog,
     gcd: Rc<GCastDiscoverer>,
 
     builder: gtk::Builder,
@@ -37,7 +37,7 @@ pub struct StreamingDialog {
 impl StreamingDialog {
     pub fn new(sender: Sender<Action>) -> Self {
         let builder = gtk::Builder::new_from_resource("/de/haeckerfelix/Shortwave/gtk/streaming_dialog.ui");
-        get_widget!(builder, libhandy::Dialog, streaming_dialog);
+        get_widget!(builder, gtk::Dialog, streaming_dialog);
 
         // Setup Google Cast discoverer
         let gcd_t = GCastDiscoverer::new();
@@ -127,7 +127,7 @@ impl StreamingDialog {
         get_widget!(self.builder, gtk::Button, connect_button);
         connect_button.connect_clicked(clone!(@weak self.builder as builder, @weak self.gcd as gcd, @strong self.sender as sender => move |_| {
             get_widget!(builder, gtk::ListBox, devices_listbox);
-            get_widget!(builder, libhandy::Dialog, streaming_dialog);
+            get_widget!(builder, gtk::Dialog, streaming_dialog);
 
             if let Some(active_row) = devices_listbox.get_selected_row() {
                 // Very hackish way to get the selected ip address
diff --git a/src/ui/window.rs b/src/ui/window.rs
index 7d324eab..c17c7f58 100644
--- a/src/ui/window.rs
+++ b/src/ui/window.rs
@@ -169,9 +169,9 @@ impl SwApplicationWindow {
 
         // leaflet
         get_widget!(self_.window_builder, libhandy::Leaflet, leaflet);
-        leaflet.connect_property_fold_notify(clone!(@strong self as this, @weak self_.window_builder as window_builder => move |leaflet| {
+        leaflet.connect_property_folded_notify(clone!(@strong self as this, @weak self_.window_builder as window_builder => move |leaflet| {
             get_widget!(window_builder, gtk::Stack, view_stack);
-            let current_view = if leaflet.get_property_folded() && leaflet.get_visible_child_name().unwrap() == "player" {
+            let current_view = if leaflet.get_folded() && leaflet.get_visible_child_name().unwrap() == "player" {
                 View::Player
             } else {
                 match view_stack.get_visible_child_name().unwrap().as_str() {
@@ -331,7 +331,7 @@ impl SwApplicationWindow {
         get_widget!(self_.window_builder, gtk::Button, back_button);
 
         // Determine if window is currently in phone mode (leaflet = folded)
-        let phone_mode = leaflet.get_property_folded();
+        let phone_mode = leaflet.get_folded();
 
         // Determine if current visible page is library
         let library_mode = view == View::Library;
-- 
GitLab

